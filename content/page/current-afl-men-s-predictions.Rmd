---
title: "Current AFL Menâ€™s Predictions"
author: "James Day"
slug: current-afl-men-s-predictions
tags: []
categories: AFLM
---
Welcome to our all new AFL Men's ratings and tips page! Here you will the latest ratings, tips for the upcoming rounds and any simulations that have been done. I'll usually aim to update these early in the week to give you time to digest Any questions, let me know on Twitter! 


```{r setup, echo = FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
```

```{r get data, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
# Load libraries
library(fitzRoy)
library(tidyverse)
library(formattable)
library(ggthemes)
library(plussixelo)

# Get fixture data using FitzRoy
fixture <- get_fixture()

# Get processed ELO data
elo_url <- "https://github.com/jimmyday12/plussixoneblog/blob/master/data/raw-data/AFL_ELO_Hist.rda?raw=true"
load(url(elo_url))

# Fix for names and elo (will change into the season)
results <- datNew %>%
  mutate(Team = replace_teams(Team)) %>%
  mutate(ELO_pre = ELO_post, 
         ELO_post = plussixelo:::calculate_season_carryover(ELO_post, weight = 0.6))

```

## AFL Men's Ratings
Below are the updated AFL Men's ratings. The figure shows the current rating in green, with the tail indicating the previous rating for that team. 

```{r ratings, echo=FALSE, message=FALSE, warning=FALSE}
# Get current ELO ratings
elo <- results %>% 
  group_by(Team) %>%
  arrange(Game) %>%
  filter(Game == last(Game) & !Team %in% c("Fitzroy", "University")) %>%
  mutate(ELO_norm = ELO_post - 1500)
  


ggplot(data = elo, aes(x = reorder(Team, ELO_post))) +
  geom_hline(yintercept = 1500, alpha = 0.7, linetype = 3) +
  geom_linerange(aes(ymin = ELO_pre, ymax = ELO_post), alpha = 0.3) +
  geom_point(aes(y = ELO_pre), alpha = 0.1) +
  geom_point(aes(y = ELO_post), colour = "#669999", size = 2) + 
  coord_flip() + 
  theme_minimal() +
  labs(x = "Team",
       y = "ELO Rating",
    title = "AFL Men's ELO Ratings",
       subtitle = "Showing the ELO rating of each AFL Men's team at the start of the 2018 
season in green, with the tail showing their end of 2017 rating",
       caption = "(data sourced from afltables.com)")




```


## Predictions

Below are the predictions for the current round. The margin and probability are for the home team winning, so a margin `< 0` or a probability `<0.5` indicates the away team is favourite. 

```{r Predictions, echo=FALSE, message=FALSE, warning=FALSE}
round <-  1
HGA = 35

# Get current elo and merge into current fixture
elo <- elo %>%
  select(Team, ELO_post)

# Join with current ELO
round_games <- fixture %>%
  filter(Round == round) %>%
  left_join(elo, by = c("Home.Team" = "Team")) %>% 
  rename(ELO.Home = ELO_post) %>%
  left_join(elo, by = c("Away.Team" = "Team")) %>%
  rename(ELO.Away = ELO_post)

# Do predictions
predictions <- round_games %>%
  group_by(Season.Game) %>%
  mutate(Prediction = find_expected_margin(ELO.Home - ELO.Away + HGA),
         Probability = find_expected_outcome(ELO.Home - ELO.Away + HGA),
         Result = case_when(
           Probability > 0.5 ~ paste(Home.Team, "by", Prediction),
           Probability < 0.5 ~ paste(Away.Team, "by", -Prediction),
           TRUE ~ "Draw"
         )) %>%
  ungroup() %>%
  select(Date, Venue, Home.Team, Away.Team, Prediction, Probability, Result)

# Pass those onto Formattable
predictions %>%
formattable(list(
  Home.Team = formatter("span", style = ~ style("font-weight" = ifelse(Probability >= 0.5, "bold", NA))),
  Away.Team = formatter("span", style = ~ style("font-weight" = ifelse(Probability <= 0.5, "bold", NA)))
  )
  ) 

```