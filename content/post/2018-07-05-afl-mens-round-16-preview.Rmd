---
title: AFL Mens Round 16 preview
author: James Day
date: '2018-07-05'
slug: afl-mens-round-16-preview
categories:
  - AFLM
tags: []
subtitle: ''
---

Here we are for another damn Thursday night game. I actually quite like them except that I never have time to write my preview! Check out my full tips at [this link](http://plussixoneblog.com/page/aflm-current-tips/) or on [Squiggle](squiggle.com.au). 


```{r setup, echo = FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)

# Load libraries
library(pacman)
pacman::p_load(fitzRoy, tidyverse, formattable, ggthemes, elo, here, lubridate, widgetframe)

# Load data that has been run using 'weekly_data_process.R'
dat_list <- read_rds(here::here("data", "raw-data", "AFLM.rds"))
sim_dat_list <- read_rds(here::here("data", "raw-data", "AFLM_sims.rds"))
elo <- dat_list$elo
```

## Ratings
```{r echo=FALSE, message=FALSE, warning=FALSE}
# Get the round data
elo_round <- dat_list$elo %>%
  filter(Game == last(Game) & !Team %in% c("Fitzroy", "University"))

sim_round <- sim_dat_list$sim_data_summary %>%
  filter(Round == last(dat_list$elo$Round.Number))

# Create a subtitle for plot
subt <- paste(
  "Showing the ELO rating of each AFL Men's team at the end of Round",
  dat_list$elo$Round.Number %>% last(), "",
  dat_list$elo$Date %>% last() %>% year(),
  "in green,\nwith the tail showing their previous rating"
)

# Do ggplot
elo_round %>%
  ggplot(aes(x = reorder(Team, ELO))) +
  geom_hline(yintercept = 1500, alpha = 0.7, linetype = 3) +
  geom_linerange(aes(ymin = ELO_pre, ymax = ELO), alpha = 0.3) +
  geom_point(aes(y = ELO_pre), alpha = 0.1) +
  geom_point(aes(y = ELO), colour = "#669999", size = 2) +
  coord_flip() +
  theme_minimal() +
  labs(
    x = "Team",
    y = "ELO Rating",
    title = "AFL Men's ELO Ratings",
    subtitle = subt,
    caption = "(data sourced from afltables.com)"
  )
```
After my recent update to the ratings system where my k-value (how much ELO ratings change after a game) is reducing as the season goes by, our ratings are somewhat stable. We still have a big gap between our top 11 and bottom 6, with Essendon sitting somewhere in between. Geelong still sits on top, just, over Richmond and Sydney. And there is very little separating those other 7 teams as they jostle for finals spots! 

## Sims

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Combine Simulation and ELO data
elo_table <- elo_round %>%
  left_join(sim_round, by = "Team") %>%
  ungroup() %>%
  mutate(ELO.change = ELO - ELO_pre,
         change = min_rank(desc(ELO_pre)) - min_rank(desc(ELO))) %>%
  mutate_at(c("Top.8", "Top.4", "Top.1"), formattable::percent, digits = 1) %>%
  mutate_at(c("ELO", "ELO.change"), as.integer) %>%
  mutate_at("Wins", round, 1) %>%
  select(Team, change, ELO, ELO.change, Wins, Top.8, Top.4, Top.1) %>%
  arrange(desc(Wins))

# Write to formattable with some formatting
# Create a sign formatrer
sign_formatter <- formatter("span", 
                            style = x ~ style(color = case_when(
                              x > 0 ~ "green", 
                              x < 0 ~ "red",
                              TRUE ~ "transparent")))
# Create formattable/DT object
dt_elo <- elo_table %>%
  formattable(list(
    change = sign_formatter,
    ELO = normalize_bar("#20B2AA80"),
    ELO.change = sign_formatter,
    Top.8 = color_tile("transparent", "lightblue"),
    Top.4 = color_tile("transparent", "lightblue"),
    Top.1 = color_tile("transparent", "lightblue")
  )) %>% 
  as.datatable(options = list(dom = 't', pageLength = 18))

frameWidget(dt_elo, height = 700, width = '95%')
```


It was a strange weekend last weekend where all the finals hopefuls lost. That means that we didn't get any clearer as to who is going to snatch those last finals spots. Richmond, Sydney, West Coast and Port all look pretty set, finishing in the finals in >90% of sims. Collingwood isn't far behind.

The leaves, realistically, 6 teams with a decent shot of those last 3 spots. Hawks and Geelong, virtue of their soft draws and bank wins, respectively, are our best shots. Interestingly, the Hawks chances went up last week despite losing! 

Melbourne, GWS and North, in that order, all sit around the 50% mark and seem most likely the be on of those two teams snatching that final 8 spot. In saying that, Adelaide kept their hopes alive with a win last week and the stumbling of the other teams. 

Keep watching I guess! 

## Predictions
```{r predict, echo=FALSE, message=FALSE, warning=FALSE, paged.print=TRUE}
# Load libraries
library(pacman)
pacman::p_load(fitzRoy, tidyverse, formattable, 
               ggthemes, elo, here, lubridate, 
               widgetframe, ggridges, DT)

# Load data that has been run using 'weekly_data_process.R'
dat_list <- read_rds(here::here("data", "raw-data", "AFLM.rds"))

# Get predictions for current round and present as table
dat_list$predictions %>%
  filter(Round.Number == last(dat_list$elo$Round.Number + 1)) %>%
  select(-Time, -Round.Number) %>%
  mutate_at("Probability", formattable::percent, digits = 1) %>%
  formattable(list(
    Home.Team = formatter(
      "span", style =
        ~ style("font-weight" = ifelse(Probability >= 0.501, "bold", NA))
    ),
    Away.Team = formatter(
      "span", style =
        ~ style("font-weight" = ifelse(Probability <= 0.499, "bold", NA))
    )
  ))
```

As per the last few rounds, it's those contenders that we want to watch this weekend. Sydney and Geelong will be an important game mostly for Geelong to keep their nose in front of the the chasing pack. Adelaide probably needs to atone against Richmond to stay in double digit chances. Hawthorn needs to ensure that it wins games like this one while GWS simply must keep winning, despite their mounting injury list.

Happy tipping! 
