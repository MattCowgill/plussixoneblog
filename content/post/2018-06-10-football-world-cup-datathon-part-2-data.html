---
title: 'Football World Cup Datathon - Part 2: Data Aquisition'
author: James Day
date: '2018-06-10'
slug: football-world-cup-datathon-part-2-data-aquisition
categories:
  - Football
  - World Cup Datathon
tags: []
draft: true
output: 
  html_document: 
    toc: yes
---



<p>In Part 1, we talked about the intro to this task and created a baseline test model. I now want to go a bit more in depth doing some early data exploration and getting some extra data.</p>
<pre class="r"><code>library(pacman)
pacman::p_load(tidyverse, lubridate, rvest, zoo, ggthemes)</code></pre>
<p>I don’t have a lot of time to do a deep dive into different football prediction models (and the effort required to acquire the data) so as a simple proxy for team strength, I’m going to combine a few different rating systems I’ve found that are relatively accesable and create some kind of blended system using some machine learning packages. This is more a chance to use those than anything else.</p>
<div id="betfair" class="section level2">
<h2>Betfair</h2>
<p>Betfair has provided all participants with data. That is hosted here.</p>
<pre class="r"><code>betfair_dat &lt;- read_csv(here::here(&quot;projects&quot;, &quot;world-cup-2018&quot;, &quot;wc_datathon_dataset.csv&quot;))
glimpse(betfair_dat)</code></pre>
<pre><code>## Observations: 14,568
## Variables: 12
## $ date                &lt;date&gt; 2000-06-10, 2000-06-11, 2000-06-11, 2000-...
## $ team_1              &lt;chr&gt; &quot;Belgium&quot;, &quot;France&quot;, &quot;Netherlands&quot;, &quot;Turke...
## $ team_2              &lt;chr&gt; &quot;Sweden&quot;, &quot;Denmark&quot;, &quot;Czech Republic&quot;, &quot;It...
## $ team_1_goals        &lt;int&gt; 2, 3, 1, 1, 1, 3, 3, 0, 0, 3, 1, 0, 0, 1, ...
## $ team_2_goals        &lt;int&gt; 1, 0, 0, 2, 1, 2, 3, 1, 2, 0, 0, 1, 1, 2, ...
## $ tournament          &lt;chr&gt; &quot;Euro 2000&quot;, &quot;Euro 2000&quot;, &quot;Euro 2000&quot;, &quot;Eu...
## $ is_team_1_home      &lt;lgl&gt; TRUE, FALSE, TRUE, FALSE, FALSE, FALSE, FA...
## $ is_team_2_home      &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, ...
## $ is_neutral          &lt;lgl&gt; FALSE, TRUE, FALSE, TRUE, TRUE, TRUE, TRUE...
## $ team_1_betfair_odds &lt;dbl&gt; 2.72, 1.68, 1.80, 5.90, 2.22, 3.60, 1.76, ...
## $ draw_betfair_odds   &lt;dbl&gt; 2.90, 3.75, 3.45, 3.25, 3.10, 3.10, 3.65, ...
## $ team_2_betfair_odds &lt;dbl&gt; 3.30, 6.60, 5.90, 1.86, 4.20, 2.40, 5.80, ...</code></pre>
<p>So - it looks like each row is a game that contains the final score, the tournament, who is the home team and then the odds of each outcome.</p>
<p>One thing I noticed when I downloaded that file was that there were NA values in some columns. Let’s count how many.</p>
<pre class="r"><code>summary(betfair_dat)</code></pre>
<pre><code>##       date               team_1             team_2         
##  Min.   :1998-07-15   Length:14568       Length:14568      
##  1st Qu.:2003-10-11   Class :character   Class :character  
##  Median :2008-06-14   Mode  :character   Mode  :character  
##  Mean   :2008-06-12                                        
##  3rd Qu.:2013-03-22                                        
##  Max.   :2017-11-15                                        
##                                                            
##   team_1_goals     team_2_goals     tournament        is_team_1_home 
##  Min.   : 0.000   Min.   : 0.000   Length:14568       Mode :logical  
##  1st Qu.: 0.000   1st Qu.: 0.000   Class :character   FALSE:2788     
##  Median : 1.000   Median : 1.000   Mode  :character   TRUE :11780    
##  Mean   : 1.608   Mean   : 1.051                                     
##  3rd Qu.: 2.000   3rd Qu.: 2.000                                     
##  Max.   :31.000   Max.   :15.000                                     
##                                                                      
##  is_team_2_home  is_neutral      team_1_betfair_odds draw_betfair_odds
##  Mode :logical   Mode :logical   Min.   :  1.010     Min.   :  1.010  
##  FALSE:14568     FALSE:11800     1st Qu.:  1.460     1st Qu.:  3.350  
##                  TRUE :2768      Median :  2.140     Median :  3.800  
##                                  Mean   :  5.947     Mean   :  6.685  
##                                  3rd Qu.:  3.600     3rd Qu.:  5.300  
##                                  Max.   :980.000     Max.   :980.000  
##                                  NA&#39;s   :5764        NA&#39;s   :5764     
##  team_2_betfair_odds
##  Min.   :   1.01    
##  1st Qu.:   2.30    
##  Median :   4.10    
##  Mean   :  13.28    
##  3rd Qu.:   9.00    
##  Max.   :1000.00    
##  NA&#39;s   :5764</code></pre>
<p>So it’s just odds data that is missing, but it’s missing for about a third of our dataset. I’m going to explore this more in another post but as a quick look, let’s see what the range of data is in terms of dates.</p>
<pre class="r"><code>betfair_dat %&gt;%
  ggplot(aes(as.yearmon(date), fill = is.na(draw_betfair_odds))) + 
  geom_bar() +
  labs(title = &quot;Number of games per month&quot;) + 
  theme_minimal()</code></pre>
<p><img src="/post/2018-06-10-football-world-cup-datathon-part-2-data_files/figure-html/plot_betfair-1.png" width="672" /></p>
<p>So, we have odds data that is pretty evenly spread from late 1998 all the way to 2017. Most of our missing odds are from older matches but some exists in later matches.</p>
</div>
<div id="kaggle-odds-dataset" class="section level2">
<h2>Kaggle Odds dataset</h2>
<p>I found this dataset on <a href="https://www.kaggle.com/austro/beat-the-bookie-worldwide-football-dataset/data">Kaggle</a> that has the odds for almost 500k matches! Most of those are league games but we should be able to get rid of those when we join it to our other datasets.</p>
<pre class="r"><code>odds_dat &lt;- read_csv(here::here(&quot;projects&quot;, &quot;world-cup-2018&quot;, &quot;closing_odds.csv&quot;))

glimpse(odds_dat)</code></pre>
<pre><code>## Observations: 479,440
## Variables: 19
## $ match_id            &lt;int&gt; 170088, 170089, 170090, 170091, 170092, 17...
## $ league              &lt;chr&gt; &quot;England: Premier League&quot;, &quot;England: Premi...
## $ match_date          &lt;date&gt; 2005-01-01, 2005-01-01, 2005-01-01, 2005-...
## $ home_team           &lt;chr&gt; &quot;Liverpool&quot;, &quot;Fulham&quot;, &quot;Aston Villa&quot;, &quot;Bol...
## $ home_score          &lt;int&gt; 0, 3, 1, 1, 1, 2, 2, 1, 5, 0, 0, 0, 0, 0, ...
## $ away_team           &lt;chr&gt; &quot;Chelsea&quot;, &quot;Crystal Palace&quot;, &quot;Blackburn&quot;, ...
## $ away_score          &lt;int&gt; 1, 1, 0, 1, 3, 1, 1, 1, 2, 2, 1, 0, 2, 2, ...
## $ avg_odds_home_win   &lt;dbl&gt; 2.9944, 1.9456, 1.8522, 1.6122, 5.9878, 1....
## $ avg_odds_draw       &lt;dbl&gt; 3.1944, 3.2333, 3.2611, 3.4133, 3.4778, 3....
## $ avg_odds_away_win   &lt;dbl&gt; 2.2256, 3.6722, 4.0144, 5.4722, 1.5567, 4....
## $ max_odds_home_win   &lt;dbl&gt; 3.20, 2.04, 2.00, 1.67, 7.00, 1.73, 1.91, ...
## $ max_odds_draw       &lt;dbl&gt; 3.25, 3.30, 3.40, 3.57, 3.60, 3.50, 3.40, ...
## $ max_odds_away_win   &lt;dbl&gt; 2.29, 4.15, 4.50, 6.27, 1.62, 5.00, 4.33, ...
## $ top_bookie_home_win &lt;chr&gt; &quot;Paddy Power&quot;, &quot;Pinnacle Sports&quot;, &quot;Pinnacl...
## $ top_bookie_draw     &lt;chr&gt; &quot;Sportingbet&quot;, &quot;bet-at-home&quot;, &quot;Paddy Power...
## $ top_bookie_away_win &lt;chr&gt; &quot;Expekt&quot;, &quot;Expekt&quot;, &quot;Sportingbet&quot;, &quot;Pinnac...
## $ n_odds_home_win     &lt;int&gt; 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 8, 8, 8, 8, ...
## $ n_odds_draw         &lt;int&gt; 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 8, 8, 8, 8, ...
## $ n_odds_away_win     &lt;int&gt; 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 8, 8, 8, 8, ...</code></pre>
<pre class="r"><code>summary(odds_dat)</code></pre>
<pre><code>##     match_id         league            match_date        
##  Min.   :170088   Length:479440      Min.   :2005-01-01  
##  1st Qu.:394532   Class :character   1st Qu.:2009-07-05  
##  Median :566276   Mode  :character   Median :2011-12-17  
##  Mean   :551865                      Mean   :2011-06-19  
##  3rd Qu.:715668                      3rd Qu.:2013-10-08  
##  Max.   :876812                      Max.   :2015-06-30  
##   home_team           home_score       away_team           away_score   
##  Length:479440      Min.   :  0.000   Length:479440      Min.   :  0.0  
##  Class :character   1st Qu.:  1.000   Class :character   1st Qu.:  0.0  
##  Mode  :character   Median :  1.000   Mode  :character   Median :  1.0  
##                     Mean   :  1.539                      Mean   :  1.2  
##                     3rd Qu.:  2.000                      3rd Qu.:  2.0  
##                     Max.   :101.000                      Max.   :102.0  
##  avg_odds_home_win avg_odds_draw    avg_odds_away_win max_odds_home_win
##  Min.   :  0.000   Min.   : 1.010   Min.   :  0.000   Min.   :  0.000  
##  1st Qu.:  1.658   1st Qu.: 3.200   1st Qu.:  2.418   1st Qu.:  1.750  
##  Median :  2.084   Median : 3.361   Median :  3.200   Median :  2.200  
##  Mean   :  2.525   Mean   : 3.670   Mean   :  3.975   Mean   :  2.789  
##  3rd Qu.:  2.643   3rd Qu.: 3.735   3rd Qu.:  4.607   3rd Qu.:  2.850  
##  Max.   :151.000   Max.   :51.000   Max.   :103.024   Max.   :209.040  
##  max_odds_draw     max_odds_away_win top_bookie_home_win
##  Min.   :  1.010   Min.   :  0.000   Length:479440      
##  1st Qu.:  3.300   1st Qu.:  2.580   Class :character   
##  Median :  3.560   Median :  3.500   Mode  :character   
##  Mean   :  3.942   Mean   :  4.573                      
##  3rd Qu.:  4.000   3rd Qu.:  5.200                      
##  Max.   :150.000   Max.   :501.000                      
##  top_bookie_draw    top_bookie_away_win n_odds_home_win  n_odds_draw   
##  Length:479440      Length:479440       Min.   : 0.00   Min.   : 1.00  
##  Class :character   Class :character    1st Qu.: 9.00   1st Qu.: 9.00  
##  Mode  :character   Mode  :character    Median :17.00   Median :17.00  
##                                         Mean   :16.45   Mean   :16.46  
##                                         3rd Qu.:25.00   3rd Qu.:25.00  
##                                         Max.   :29.00   Max.   :29.00  
##  n_odds_away_win
##  Min.   : 0.00  
##  1st Qu.: 9.00  
##  Median :17.00  
##  Mean   :16.45  
##  3rd Qu.:25.00  
##  Max.   :29.00</code></pre>
<p>So this dataset has different odds but has it for way more data and nothing missing. One problem I might have is that I’m not sure I can get these specific odds (bookies) easily for the World Cup games. If I want to include it in a model that will be an issue. I’ll need to see what I can get.</p>
</div>
<div id="fifa" class="section level2">
<h2>FIFA</h2>
<p>Logically, if we wanted to try and assess team ratings we could look towards the official <a href="https://www.fifa.com/fifa-world-ranking/ranking-table/men/index.html">FIFA World rankings</a>. These are used for primarily for seeding in tournaments, such as the World Cup. In researching for this project, I found that these are generally <a href="https://en.wikipedia.org/wiki/FIFA_World_Rankings">critisied for being too simplistic</a> and most people prefer ELO rating systems. Nonetheless, it is a dataset I am able to get access to and, given it is used for seeding in the World Cup, there may be some value for including them in a model.</p>
<div id="scraping-data" class="section level3">
<h3>Scraping data</h3>
<p>The code to get this information has been adapted from a <a href="https://github.com/rboberg/rross/blob/master/Soccer/2014/WorldCup/Scrape%20Fifa%20World%20Rankings.R">Github respository</a> I found from Github user <a href="https://github.com/rboberg">Ross Boberg</a>.</p>
<p>If you would prefer to take a scripted version of my code below, you can find that <a href="https://github.com/jimmyday12/plussixoneblog/blob/master/projects/world-cup-2018/scrape_fifa.R">here</a>. You can also just grab the data directly from <a href="https://github.com/jimmyday12/plussixoneblog/blob/master/projects/world-cup-2018/fifa_rank_history.csv">here</a>.</p>
<p>Firstly, we have to create a function that builds us a URL. We can then use this to get all the combinations of URLS we need. Based on Ross’ work, we know that each URL contains a query for <code>rank</code>, <code>confediration</code>, <code>gender</code> and <code>page</code>. This function will dynamically generate the URL with the values for those queries.</p>
<p>Now, let’s generate a bunch of URL’s. Based on Ross’s code, I know the rough start and end points for <code>rank</code> and I also know the id’s of the <code>confedirations</code>.</p>
<pre class="r"><code># Specify parameters
start_rank = 286 # the last update (as of Jun 5th, 2018)
end_rank = 57 # corresponds to Jan99, when point method was revised
conf_ids = c(23913, 23914, 23915, 23916, 25998, 27275)

rank &lt;- rep(start_rank:end_rank, each = length(conf_ids))
conf_vec &lt;- rep(conf_ids, times = length(start_rank:end_rank))

urls &lt;- rank %&gt;%
  map2_chr(conf_vec, ~ get_ranking_table_URL(rank = .x, confederation = .y))

length(urls)</code></pre>
<pre><code>## [1] 1380</code></pre>
<p>Now we’ve got a list of URL’s to search through - I can pass them to <code>read_html</code> and generate local HTML files for me to use. This is the most time consuming part of this process - this function took my laptop ~13 min to run so be mindful if you are following along! I’ve actually just done the first 10 of 1380 for this blog post so comment that out if needed.</p>
<pre class="r"><code># Uncomment 1st line and comment out 2nd line to do all data. I&#39;ve just done 1st 10 for illustration purposes
# ind &lt;- seq_along(urls)
ind &lt;- 1:10 

htmls &lt;- urls[ind] %&gt;%
  map(read_html)</code></pre>
<p>Success! Now we’ve got those htmls, we can do some extraction and data cleaning. We basically just need to get the dates and then the table of data on each page. Again, using the handy <code>purrr</code> package to do our heavy lifting makes this relatively simple.</p>
<pre class="r"><code># Read date
dates &lt;- htmls %&gt;% 
  map(~html_nodes(.x, &quot;.lb&quot;)) %&gt;%
  map(html_text) %&gt;%
  map_chr(~str_remove(.x, &quot;Last Updated &quot;)) %&gt;%
  map(dmy) 

# Read Tables
tables &lt;- htmls %&gt;% 
  map(~html_nodes(.x, &quot;#tbl_rankingTable&quot;)) %&gt;%
  map(html_table) %&gt;%
  map(as.data.frame)

# Add date, conf id and make into one dataframe
fifa_dat &lt;- tables %&gt;%
  map2(dates, ~ .x %&gt;% mutate(Date = .y)) %&gt;%
  map2(conf_vec[ind], ~ .x %&gt;% mutate(Conference_id = .y)) %&gt;%
  reduce(bind_rows) %&gt;%
  select(Date, Team, Pts, Conference_id) %&gt;%
  arrange(Date, desc(Pts))

head(fifa_dat)</code></pre>
<pre><code>##         Date      Team  Pts Conference_id
## 1 2018-04-12    Brazil 1384         23915
## 2 2018-04-12 Argentina 1254         23915
## 3 2018-04-12     Chile 1146         23915
## 4 2018-04-12      Peru 1106         23915
## 5 2018-04-12   Tunisia 1012         23913
## 6 2018-04-12    Mexico 1008         23914</code></pre>
<p>Great - so now we have the official FIFA ranking points!</p>
</div>
</div>
<div id="other-source" class="section level2">
<h2>Other source</h2>
<p>I had looked at some other sources but found it either too tricky or they didn’t have wide enough covered. These including trying to include ‘team value’ information from Transfermarkt. I think this would be awesome but I could only get the value of each of the current World Cup squads. I’m sure it’s possible to try and find backdate information but I don’t have the time.</p>
<p>Another option that would be cool would be to use the EA Sports FIFA player ratings as a bit of a proxy for the talent in each team. I did find some promising websites but they were ultimately going to take too much time to scrape.</p>
</div>
<div id="combining-dataset" class="section level1">
<h1>Combining dataset</h1>
<p>Now that we have acquired our data, we need to combine it in some way to make one big datafile. Again, I want this to be one row per match and it’s going to be fairy wide.</p>
<p>I’m first going to read in the big fifa file (the one I scraped above is just a subset - find this <a href="https://github.com/jimmyday12/plussixoneblog/blob/master/projects/world-cup-2018/fifa_rank_history.csv">here</a>).</p>
<pre class="r"><code>fifa_dat &lt;- read_csv(here::here(&quot;projects&quot;, &quot;world-cup-2018&quot;, &quot;fifa_rank_history.csv&quot;))</code></pre>
<p>Now, what we want is to add the fifa data to our betfair odds. This isn’t going to a simple join I don’t think - we want to match the home team name and the date of the match to the closest date and team in our fifa file and return the rating. I’m pretty sure that the FIFA ratings get updated once per month so we may be able to join on <code>year</code>, <code>month</code> and <code>team</code></p>
<pre class="r"><code># Add in a date/month to fifa and betfair data
fifa_dat &lt;- fifa_dat %&gt;%
  mutate(year = year(Date),
         month = month(Date)) %&gt;%
  select(year, month, Team, Pts) 

betfair_dat &lt;- betfair_dat %&gt;%
  mutate(year = year(date),
         month = month(date))

odds_dat &lt;- odds_dat %&gt;%
  select(match_id, match_date, home_team, away_team, avg_odds_home_win:avg_odds_away_win)

# Join data together
dat &lt;- betfair_dat %&gt;%
  left_join(fifa_dat, by = c(&quot;year&quot;, &quot;month&quot;, &quot;team_1&quot; = &quot;Team&quot;)) %&gt;%
  rename(team_1_fifa = Pts) %&gt;%
  left_join(fifa_dat, by = c(&quot;year&quot;, &quot;month&quot;, &quot;team_2&quot; = &quot;Team&quot;)) %&gt;%
  rename(team_2_fifa = Pts) %&gt;%
  left_join(odds_dat, by = c(&quot;date&quot; = &quot;match_date&quot;, &quot;team_1&quot; = &quot;home_team&quot;, &quot;team_2&quot; = &quot;away_team&quot;))

head(dat)</code></pre>
<pre><code>## # A tibble: 6 x 20
##   date       team_1      team_2       team_1_goals team_2_goals tournament
##   &lt;date&gt;     &lt;chr&gt;       &lt;chr&gt;               &lt;int&gt;        &lt;int&gt; &lt;chr&gt;     
## 1 2000-06-10 Belgium     Sweden                  2            1 Euro 2000 
## 2 2000-06-11 France      Denmark                 3            0 Euro 2000 
## 3 2000-06-11 Netherlands Czech Repub…            1            0 Euro 2000 
## 4 2000-06-11 Turkey      Italy                   1            2 Euro 2000 
## 5 2000-06-12 Germany     Romania                 1            1 Euro 2000 
## 6 2000-06-12 Portugal    England                 3            2 Euro 2000 
## # ... with 14 more variables: is_team_1_home &lt;lgl&gt;, is_team_2_home &lt;lgl&gt;,
## #   is_neutral &lt;lgl&gt;, team_1_betfair_odds &lt;dbl&gt;, draw_betfair_odds &lt;dbl&gt;,
## #   team_2_betfair_odds &lt;dbl&gt;, year &lt;dbl&gt;, month &lt;dbl&gt;, team_1_fifa &lt;int&gt;,
## #   team_2_fifa &lt;int&gt;, match_id &lt;int&gt;, avg_odds_home_win &lt;dbl&gt;,
## #   avg_odds_draw &lt;dbl&gt;, avg_odds_away_win &lt;dbl&gt;</code></pre>
</div>
<div id="feature-engineering" class="section level1">
<h1>Feature Engineering</h1>
<div id="elo" class="section level2">
<h2>ELO</h2>
</div>
<div id="regista" class="section level2">
<h2>Regista</h2>
</div>
<div id="last-n-gameswinsgoalsconceded" class="section level2">
<h2>Last n games/wins/goals/conceded</h2>
</div>
<div id="world-cup-home-team" class="section level2">
<h2>World Cup Home Team</h2>
</div>
<div id="players" class="section level2">
<h2>Players?</h2>
</div>
</div>
<div id="data-split" class="section level1">
<h1>Data Split</h1>
</div>
<div id="baseline-model" class="section level1">
<h1>Baseline Model</h1>
</div>
