---
title: Football World Cup Datathon
author: James Day
date: '2018-06-03'
slug: football-world-cup-datathon
categories:
  - Football
tags: []
draft: true
---



<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>some text</p>
</div>
<div id="setup" class="section level1">
<h1>Setup</h1>
<p>First lets load some packages and get our data</p>
<pre class="r"><code>library(pacman)
p_load(tidyverse, here, caret, MLmetrics)</code></pre>
</div>
<div id="data-exploration" class="section level1">
<h1>Data exploration</h1>
<pre class="r"><code>dat &lt;- read_csv(here::here(&quot;data&quot;, &quot;world-cup&quot;, &quot;wc_datathon_dataset.csv&quot;))</code></pre>
<pre><code>## Parsed with column specification:
## cols(
##   date = col_date(format = &quot;&quot;),
##   team_1 = col_character(),
##   team_2 = col_character(),
##   team_1_goals = col_integer(),
##   team_2_goals = col_integer(),
##   tournament = col_character(),
##   is_team_1_home = col_logical(),
##   is_team_2_home = col_logical(),
##   is_neutral = col_logical(),
##   team_1_betfair_odds = col_double(),
##   draw_betfair_odds = col_double(),
##   team_2_betfair_odds = col_double()
## )</code></pre>
<pre class="r"><code>head(dat)</code></pre>
<pre><code>## # A tibble: 6 x 12
##   date       team_1      team_2       team_1_goals team_2_goals tournament
##   &lt;date&gt;     &lt;chr&gt;       &lt;chr&gt;               &lt;int&gt;        &lt;int&gt; &lt;chr&gt;     
## 1 2000-06-10 Belgium     Sweden                  2            1 Euro 2000 
## 2 2000-06-11 France      Denmark                 3            0 Euro 2000 
## 3 2000-06-11 Netherlands Czech Repub…            1            0 Euro 2000 
## 4 2000-06-11 Turkey      Italy                   1            2 Euro 2000 
## 5 2000-06-12 Germany     Romania                 1            1 Euro 2000 
## 6 2000-06-12 Portugal    England                 3            2 Euro 2000 
## # ... with 6 more variables: is_team_1_home &lt;lgl&gt;, is_team_2_home &lt;lgl&gt;,
## #   is_neutral &lt;lgl&gt;, team_1_betfair_odds &lt;dbl&gt;, draw_betfair_odds &lt;dbl&gt;,
## #   team_2_betfair_odds &lt;dbl&gt;</code></pre>
<pre class="r"><code>tail(dat)</code></pre>
<pre><code>## # A tibble: 6 x 12
##   date       team_1      team_2       team_1_goals team_2_goals tournament
##   &lt;date&gt;     &lt;chr&gt;       &lt;chr&gt;               &lt;int&gt;        &lt;int&gt; &lt;chr&gt;     
## 1 2017-11-12 Benin       Tanzania                1            1 Friendly  
## 2 2017-11-12 Togo        Mauritius               6            0 Friendly  
## 3 2017-11-13 Iraq        Syria                   1            1 Friendly  
## 4 2017-11-14 Algeria     Central Afr…            3            0 Friendly  
## 5 2017-11-14 Gabon       Botswana                0            0 Friendly  
## 6 2017-11-14 Trinidad a… Guyana                  1            1 Friendly  
## # ... with 6 more variables: is_team_1_home &lt;lgl&gt;, is_team_2_home &lt;lgl&gt;,
## #   is_neutral &lt;lgl&gt;, team_1_betfair_odds &lt;dbl&gt;, draw_betfair_odds &lt;dbl&gt;,
## #   team_2_betfair_odds &lt;dbl&gt;</code></pre>
<pre class="r"><code>glimpse(dat)</code></pre>
<pre><code>## Observations: 14,568
## Variables: 12
## $ date                &lt;date&gt; 2000-06-10, 2000-06-11, 2000-06-11, 2000-...
## $ team_1              &lt;chr&gt; &quot;Belgium&quot;, &quot;France&quot;, &quot;Netherlands&quot;, &quot;Turke...
## $ team_2              &lt;chr&gt; &quot;Sweden&quot;, &quot;Denmark&quot;, &quot;Czech Republic&quot;, &quot;It...
## $ team_1_goals        &lt;int&gt; 2, 3, 1, 1, 1, 3, 3, 0, 0, 3, 1, 0, 0, 1, ...
## $ team_2_goals        &lt;int&gt; 1, 0, 0, 2, 1, 2, 3, 1, 2, 0, 0, 1, 1, 2, ...
## $ tournament          &lt;chr&gt; &quot;Euro 2000&quot;, &quot;Euro 2000&quot;, &quot;Euro 2000&quot;, &quot;Eu...
## $ is_team_1_home      &lt;lgl&gt; TRUE, FALSE, TRUE, FALSE, FALSE, FALSE, FA...
## $ is_team_2_home      &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, ...
## $ is_neutral          &lt;lgl&gt; FALSE, TRUE, FALSE, TRUE, TRUE, TRUE, TRUE...
## $ team_1_betfair_odds &lt;dbl&gt; 2.72, 1.68, 1.80, 5.90, 2.22, 3.60, 1.76, ...
## $ draw_betfair_odds   &lt;dbl&gt; 2.90, 3.75, 3.45, 3.25, 3.10, 3.10, 3.65, ...
## $ team_2_betfair_odds &lt;dbl&gt; 3.30, 6.60, 5.90, 1.86, 4.20, 2.40, 5.80, ...</code></pre>
<p>So it looks like Betafair has given us the match results, home team, the tournament and the pre-match betfair odds for all games dating back to 2000. That’s a decent start! As a minimum, I should be able to create a simple ELO model from that. In subsequent posts, I am going to explore combining that with the odds and some other data as inputs into some machine learning models to see how that looks.</p>
<p>Before I start, I just want to see if there are any NA’s as this can cause problems with lots of models.</p>
<p>One thing I did notice is that</p>
<pre class="r"><code>dat %&gt;% 
  summarise_each(funs(sum(is.na(.))))</code></pre>
<pre><code>## `summarise_each()` is deprecated.
## Use `summarise_all()`, `summarise_at()` or `summarise_if()` instead.
## To map `funs` over all variables, use `summarise_all()`</code></pre>
<pre><code>## Warning: package &#39;bindrcpp&#39; was built under R version 3.4.4</code></pre>
<pre><code>## # A tibble: 1 x 12
##    date team_1 team_2 team_1_goals team_2_goals tournament is_team_1_home
##   &lt;int&gt;  &lt;int&gt;  &lt;int&gt;        &lt;int&gt;        &lt;int&gt;      &lt;int&gt;          &lt;int&gt;
## 1     0      0      0            0            0          0              0
## # ... with 5 more variables: is_team_2_home &lt;int&gt;, is_neutral &lt;int&gt;,
## #   team_1_betfair_odds &lt;int&gt;, draw_betfair_odds &lt;int&gt;,
## #   team_2_betfair_odds &lt;int&gt;</code></pre>
<p>So it looks like we are missing around 5700 matches betting odds from a total of 14000. That might be an issue for a model that wants to use betting odds…</p>
<p>For now, let’s filter them out and I’ll see if we can either retreive them or decide to not use that as an input.</p>
<pre class="r"><code>dat &lt;- dat %&gt;% 
  na.omit</code></pre>
</div>
<div id="baseline-model" class="section level1">
<h1>Baseline Model</h1>
<p>Before starting - I think I’m going to take the implied probability from betfair as the baseline model. Any model I implement needs to be an improvement on that!</p>
<div id="data-splitting" class="section level2">
<h2>Data splitting</h2>
<p>In order to test any models we use, I’m going to split our data into training and testing data. This is important in that it gives us a way to test our models without including that testing data in the information we give our models - in essence, we can assess the models performance on “unseen” data.</p>
<p>Typically, this is done by taking a random sample of 20% of the data as the test data, and only training your model on the remaining 80%. I’m not sure if this is a good approach for time based models but I’m going to do it for now.</p>
<pre class="r"><code>set.seed(42)
dat &lt;- dat %&gt;%
  mutate(id = row_number())

train_index &lt;- createDataPartition(dat$id, p = 0.8, list = F)

dat_train &lt;- dat[train_index, ]
dat_test &lt;- dat[-train_index, ]</code></pre>
<p>Now to take the implied odds as my simple model - this is done by taking the 1/odds for each of the main outcomes - win, draw and loss - for team 1.</p>
<pre class="r"><code>dat_test &lt;- dat_test %&gt;%
  mutate(win = 1/team_1_betfair_odds,
         draw = 1/draw_betfair_odds,
         lose = 1/team_2_betfair_odds)

# They each need to add to 1
dat_test &lt;- dat_test %&gt;%
  mutate(sum = win + draw + lose) %&gt;%
  mutate_at(c(&quot;win&quot;, &quot;draw&quot;, &quot;lose&quot;), funs(./sum))</code></pre>
<p>Now to calculate the <code>log_loss</code> value for our model. This is how the winner of the competition will be assessed and so it’s what I’ll base all of my models training on. In order to do this, I need the actual outcome as a column as well.</p>
<pre class="r"><code>dat_test &lt;- dat_test %&gt;%
  mutate(outcome = factor(case_when(
    team_1_goals &gt; team_2_goals ~ &quot;win&quot;,
    team_1_goals &lt; team_2_goals ~ &quot;lose&quot;,
    TRUE ~ &quot;draw&quot;
  )))

pred &lt;- dat_test %&gt;%
  select(win:lose) %&gt;%
  as.matrix()

actual &lt;- dat_test$outcome

MultiLogLoss(y_pred = pred, y_true = dat_test$outcome)</code></pre>
<pre><code>## [1] 1.726516</code></pre>
</div>
</div>
